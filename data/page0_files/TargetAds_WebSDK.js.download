function TargetAds(t,e={}){if(!t)throw{name:"TargetAdsInitializationError",message:"projectId is invalid"};"object"!=typeof e&&console.warn("TargetAds:Incorrect type of settings for debug mode",e),this.host="https://eye.targetads.io",this.projectId=t,this.storPrefix=`_tads${t}_cid`,this.yandexuidPrefix=`_tads${t}_yandexuid`,this.sessionIdPrefix=`_tads${t}_sid`,this.__debug=e.debug||!1,this.__otrack=e.other_trackers||!0,this.isCheckUtm=e.check_utm||!1,this.__limittime=3e5,this.__timeout=3e4,this.currentUrl=window.location.href,this.isCheckAnchor=e.isCheckLocationAnchor||!1,this.isCheckLocation=e.isCheckLocation||!1,this.isOnlyOneInDay=e.isOnlyOneInDay||!1,this.startSession=0,this.getCid=()=>{if(window.localStorage.getItem(this.storPrefix))return window.localStorage.getItem(this.storPrefix);let t=`TA-${Date.now()}-${(Math.random()+1).toString(36).substring(4).toUpperCase()}`;return window.localStorage.setItem(this.storPrefix,t),t},this.getYandexuid=()=>{try{if(window.location.href.includes("yandexuid")){const t=new URLSearchParams(window.location.search).get("yandexuid");if(t)return localStorage.setItem(this.yandexuidPrefix,t),t}if(window.localStorage.getItem(this.yandexuidPrefix))return window.localStorage.getItem(this.yandexuidPrefix)}catch(t){return this.log(t),""}},window._targetADS=this.event.bind(this),this.listenerLocation=()=>{this.isCheckLocation&&window.addEventListener("popstate",(()=>{this.onChangeLocation()}))},this.getSid=()=>{const t=window.localStorage.getItem(this.sessionIdPrefix);return t||""}}TargetAds.prototype.getUserAgent=function(){let t=window.navigator&&window.navigator.userAgent;return t||""},TargetAds.prototype.log=function(t,e=!1){this.__debug&&console.info("TargetAds:"+t)},TargetAds.prototype.req=async function(t,e,r=0){if(this.log(`Sending data:${e}`),this.log(`Sending query:${t}`),r*this.__timeout>=this.__limittime)return this.log(`Max retries for:${e}`,!0);const i=TargetAdsQueues.peek();TargetAdsQueues.dequeue(i);const s=new AbortController,o=setTimeout((()=>{s.abort()}),this.__timeout);try{const n=await fetch(`${this.host}/web/collect?${t}`,{method:"POST",cache:"no-cache",credentials:"include",headers:{"Content-Type":"text/plain"},referrerPolicy:"no-referrer-when-downgrade",body:e,signal:s.signal});if(clearTimeout(o),0===TargetAdsQueues.length?localStorage.removeItem(`_tads${this.projectId}_queue`):localStorage.setItem(`_tads${this.projectId}_queue`,JSON.stringify(TargetAdsQueues)),200===n.status||204===n.status){this.log("Data was send");const t=await n.text();t&&!isNaN(Number(t))&&window.localStorage.setItem(this.storPrefix,t)}else TargetAdsQueues.enqueue(i),setTimeout((()=>{this.req(t,e,r+1)}),this.__timeout),this.log(`Data wasn't send.Status code is ${n.status}.Response text ${n.body}`,!0)}catch(s){clearTimeout(o),"AbortError"===s.name?this.log(`Request timeout after ${this.__timeout}ms`,!0):this.log(s,!0),TargetAdsQueues.enqueue(i),setTimeout((()=>{this.req(t,e,r+1)}),this.__timeout)}},TargetAds.prototype.getOtherCounters=function(){if(!this.__otrack)return{};if(!TargetAdsIsCookiesAvailable())return this.log("Cookies are not available",!0),{ycid:"",gcid:""};const t=document.cookie.match("(?:^|;)\\s*_ym_uid=([^;]*)"),e=t?decodeURIComponent(t[1]):"",r=document.cookie.match("(?:^|;)\\s*_ga=([^;]*)");return{ycid:e,gcid:r?decodeURIComponent(r[1]):""}},TargetAds.prototype.waitForYandexCounter=function(t=7,e=300){return new Promise((r=>{if(!this.__otrack)return void r(!1);if(!TargetAdsIsCookiesAvailable())return this.log("Cookies are not available",!0),void r(!1);let i=0;const s=()=>{document.cookie.match("(?:^|;)\\s*_ym_uid=([^;]*)")?r(!0):(i++,i>=t?r(!1):setTimeout(s,e))};s()}))},TargetAds.prototype.defaultParams=function(){return{dl:this.convertToString(document.location.href),ref:this.convertToString(document.referrer),ul:this.convertToString(window.navigator.language.toLowerCase()),ww:this.convertToString(window.screen.availWidth),wh:this.convertToString(window.screen.availHeight),dt:this.convertToString(document.title),pid:this.convertToString(this.projectId),cid:this.getCid(),yandexuid:this.convertToString(this.getYandexuid())}},TargetAds.prototype.convertToString=function(t){if((t||0===t)&&"object"!=typeof t)try{return String(t)}catch(t){return""}return""},TargetAds.prototype.isValidString=function(t){if(null==t)return!1;if(""===(t=String(t)).trim())return!1;return!["null","undefined","nan","n/a","not applicable","none"].includes(t.toLowerCase())},TargetAds.prototype.convertToNumber=function(t){try{if(t===1/0||t===-1/0)return 0;const e=Number(t);return isNaN(e)?0:e}catch(t){return 0}},TargetAds.prototype.convertToObjectString=function(t,e=0){if(t&&"object"==typeof t)try{const r={};return e?Object.keys(t).slice(0,e).map((e=>r[e]=this.convertToString(t[e]))):Object.keys(t).map((e=>r[e]=this.convertToString(t[e]))),r}catch(t){return{}}return{}},TargetAds.prototype.getValueOrDefault=function(t,e,r,i){if(t&&"object"==typeof t&&t[e]){if("string"===i&&"object"!=typeof t[e])return this.convertToString(t[e]);if("number"===i)return this.convertToNumber(t[e])}return r},TargetAds.prototype.onChangeLocation=function(){const t=window.location.href;if(((t,e,r=!1)=>{try{if(/#\/.*/.test(t)&&/#\/.*/.test(e)){const i=t.split("#/")[1],s=e.split("#/")[1];return r?i!==s:i.split("#")[0]!==s.split("#")[0]}return r?t!==e:t.split("#")[0]!==e.split("#")[0]}catch(t){this.log(t)}return!1})(this.currentUrl,t,this.isCheckAnchor))return this.event("page_view"),this.currentUrl=t,t},TargetAds.prototype.prepaidEcomData=function(t,e){let r={};if("purchase"===t){if(!e.hasOwnProperty("id")||"object"!=typeof e.items||e.items.length<1)return this.log("Purchase id and items is required",!0),-1;r.ecommerce={type:t,id:this.getValueOrDefault(e,"id","","string"),quantity:this.getValueOrDefault(e,"quantity",0,"number"),amount:this.getValueOrDefault(e,"amount",0,"number")},r.ecommerce_items={id:[],title:[],category1:[],category2:[],brand:[],variant:[],quantity:[],price:[]};for(const t of e.items)t.hasOwnProperty("id")||t.hasOwnProperty("title")?""!==this.convertToString(t.id)||""!==this.convertToString(t.title)?(r.ecommerce_items.id.push(this.getValueOrDefault(t,"id","","string")),r.ecommerce_items.title.push(this.getValueOrDefault(t,"title","","string")),r.ecommerce_items.category1.push(this.getValueOrDefault(t,"category1","","string")),r.ecommerce_items.category2.push(this.getValueOrDefault(t,"category2","","string")),r.ecommerce_items.brand.push(this.getValueOrDefault(t,"brand","","string")),r.ecommerce_items.variant.push(this.getValueOrDefault(t,"variant","","string")),r.ecommerce_items.quantity.push(this.getValueOrDefault(t,"quantity",0,"number")),r.ecommerce_items.price.push(this.getValueOrDefault(t,"price",0,"number"))):this.log("Product adding error. Name or id incorrect",!0):this.log("Product adding error. Name or id is required",!0);if(0===r.ecommerce_items.id.length||0===r.ecommerce_items.title.length)return this.log("Items must not be empty"),-1}else{if(!e.hasOwnProperty("id")&&!e.hasOwnProperty("title"))return this.log("Item name or id is required"),-1;if(""===this.convertToString(e.id)&&""===this.convertToString(e.title))return this.log("Item name or id incorrect",!0),-1;r.ecommerce_items={id:[this.getValueOrDefault(e,"id","","string")],title:[this.getValueOrDefault(e,"title","","string")],category1:[this.getValueOrDefault(e,"category1","","string")],category2:[this.getValueOrDefault(e,"category2","","string")],brand:[this.getValueOrDefault(e,"brand","","string")],variant:[this.getValueOrDefault(e,"variant","","string")],quantity:[1],price:[this.getValueOrDefault(e,"price",0,"number")]}}return r},TargetAds.prototype.event=function(t,e={}){if(t.constructor!==String){const n=TargetAdsQueues.peek();return TargetAdsQueues.dequeue(n),this.log(`Name of invalid type-${typeof t}.Should be String`,!0)}this.__debug&&(this.log(`Data for send:${t};${JSON.stringify(e)}`),this.log(`State:${localStorage.getItem("_tads_init")}`));let r={};if(window.localStorage.getItem("_tads_uid")&&(r.uid=window.localStorage.getItem("_tads_uid")),"page_view"===t){if("object"==typeof e&&Object.entries(e).length>0&&!Array.isArray(e)){let T={};for(let S in e)T[S]=e[S];T.user&&"object"==typeof T.user&&!Array.isArray(T.user)?(r.cp={},T.user.hasOwnProperty("uid")?(this.isValidString(this.convertToString(T.user.uid))?(r.uid=this.convertToString(T.user.uid),window.localStorage.setItem("_tads_uid",r.uid)):this.log("TargetAds: incorrect uid argument",!0),delete T.user.uid):this.log("TargetAds: uid argument not found",!0),r.cp=Object.assign(r.cp||{},this.convertToObjectString(T.user,5)),delete T.user):this.log("TargetAds: user object and his uid argument not found",!0),T.event_params&&"object"==typeof T.event_params&&!Array.isArray(T.event_params)&&(T.event_params.hasOwnProperty("uid")?(this.isValidString(this.convertToString(T.event_params.uid))?(r.uid=this.convertToString(T.event_params.uid),window.localStorage.setItem("_tads_uid",r.uid)):this.log("TargetAds: incorrect uid argument",!0),delete T.event_params.uid):this.log("TargetAds: uid argument not found",!0),r.cp=this.convertToObjectString(Object.assign(r.cp||{},T.event_params),5),delete T.event_params),r.cp&&r.cp.hasOwnProperty("uid")&&delete r.cp.uid}function i(t){const e=JSON.stringify(t);let r=0;for(let t=0;t<e.length;t++){r=(r<<5)-r+e.charCodeAt(t),r&=r}return r}const a=this.defaultParams(),c=(t,e=18e5)=>{const r=(new Date).getTime(),i=localStorage.getItem(t),s=i?this.convertToNumber(i):0;return localStorage.setItem(t,`${r}`),s?r-s>e?0:1:0},d=new Date;d.setHours(0,0,0,0);const u=i({date:d}),g=i({dl:a.dl,cid:a.cid,pid:a.pid,date:d,domain:this.convertToString(document.location.host)}),l="_tads_lt_"+i({pid:a.pid}),h=localStorage.getItem("_tads_v_"+u);for(let w=0;w<localStorage.length;w++){const A=localStorage.key(w);A.includes("_tads_v_")&&A!=="_tads_v_"+u&&localStorage.removeItem(A)}const m=(t,e)=>{const r=new RegExp(`${e}=([^&]+)`),i=t.match(r);if(i)return i[1]};if(c(l)&&h){const b=window.location.href,O={},I=["utm_medium","utm_source","utm_campaign","utm_term","yclid"];for(const j of I){const k=m(b,j);k&&(O[j]=k)}if(Object.keys(O).length&&this.isCheckUtm){const D=JSON.parse(h);if(D.includes(g)){if(this.startSession=0,this.isOnlyOneInDay){const P=TargetAdsQueues.peek();return void TargetAdsQueues.dequeue(P)}}else{10===D.length&&D.shift(),this.startSession=1;const C=i(`${this.projectId}_${this.getCid()}_${this.getUserAgent()}_${(new Date).getTime()}`);localStorage.setItem(this.sessionIdPrefix,String(C)),D.push(g),localStorage.setItem("_tads_v_"+u,JSON.stringify(D))}}else if(this.startSession=0,this.isOnlyOneInDay){const N=TargetAdsQueues.peek();return void TargetAdsQueues.dequeue(N)}}else{this.startSession=1;const $=i(`${this.projectId}_${this.getCid()}_${this.getUserAgent()}_${(new Date).getTime()}`);if(localStorage.setItem(this.sessionIdPrefix,String($)),h&&this.isOnlyOneInDay){const q=TargetAdsQueues.peek();return void TargetAdsQueues.dequeue(q)}localStorage.setItem("_tads_v_"+u,JSON.stringify([g])),localStorage.setItem(l,`${(new Date).getTime()}`)}const p=window.location.href,_=m(p,"pl"),f=m(p,"cn"),y=m(p,"tclick");this.convertToNumber(_)&&this.convertToNumber(f)&&y&&(r.cn=this.convertToNumber(f),r.pl=this.convertToNumber(_),r.tclick=y),r.event_name="page_view";const v=()=>{"object"==typeof r.cp&&r.cp.hasOwnProperty("uid")&&(this.isValidString(this.convertToString(r.cp.uid))||(this.log("TargetAds: incorrect uid argument in event_params",!0),delete r.cp.uid)),Object.assign(r,this.getOtherCounters());let t=Object.assign(this.defaultParams(),{edttm:Math.floor(Date.now()/1e3),sid:this.getSid()});const e={ss:this.startSession};t=Object.assign(t,e);let i=new URLSearchParams(t).toString();try{let t=JSON.stringify(r);this.req(i,t).catch((t=>this.log(t,!0)))}catch(t){return this.log(`Can not send data:${t}`,!0)}};if(this.__otrack&&1===this.startSession){const Q=TargetAdsQueues.peek();return TargetAdsQueues.dequeue(Q),void this.waitForYandexCounter().then((()=>{TargetAdsQueues.enqueue(Q),v()}))}return void v()}if("event"===t&&e&&Object.entries(e).length>0&&!Array.isArray(e)){let x={};for(let V in e)x[V]=e[V];if(window.localStorage.getItem("_tads_uid")&&(r.uid=window.localStorage.getItem("_tads_uid")),x.user&&"object"==typeof x.user&&!Array.isArray(x.user)?(r.cp={},x.user.hasOwnProperty("uid")?(this.isValidString(this.convertToString(x.user.uid))?(r.uid=this.convertToString(x.user.uid),window.localStorage.setItem("_tads_uid",r.uid)):this.log("TargetAds: incorrect uid argument",!0),delete x.user.uid):this.log("TargetAds: uid argument not found",!0),r.cp=Object.assign(r.cp||{},this.convertToObjectString(x.user,5)),delete x.user):this.log("TargetAds: user object and his uid argument not found (an optional parameter)",!0),!x.event_name||""===this.convertToString(x.event_name)){const E=TargetAdsQueues.peek();return TargetAdsQueues.dequeue(E),this.log("TargetAds: Check the event data",!0)}r.event_type=this.convertToString(x.event_type),r.event_category=this.convertToString(x.event_category),r.event_name=this.convertToString(x.event_name),r.event_value=this.convertToNumber(x.event_value),x.event_params&&"object"==typeof x.event_params&&!Array.isArray(x.event_params)&&(x.event_params.hasOwnProperty("uid")?(this.isValidString(this.convertToString(x.event_params.uid))?(r.uid=this.convertToString(x.event_params.uid),window.localStorage.setItem("_tads_uid",r.uid)):this.log("TargetAds: incorrect uid argument",!0),delete x.event_params.uid):this.log("TargetAds: uid argument not found",!0),r.cp=this.convertToObjectString(Object.assign(r.cp||{},x.event_params),5)),r.cp&&r.cp.hasOwnProperty("uid")&&delete r.cp.uid}else if("add_to_cart"===t&&Object.entries(e).length>0&&!Array.isArray(e)){const J={};for(let L in e)J[L]=e[L];if(r=this.prepaidEcomData(t,e),J.event_params&&"object"==typeof J.event_params&&!Array.isArray(J.event_params)&&(J.event_params.hasOwnProperty("uid")?(this.isValidString(this.convertToString(J.event_params.uid))?(r.uid=this.convertToString(J.event_params.uid),window.localStorage.setItem("_tads_uid",r.uid)):this.log("TargetAds: incorrect uid argument",!0),delete J.event_params.uid):this.log("TargetAds: uid argument not found",!0),r.cp=this.convertToObjectString(Object.assign(r.cp||{},J.event_params),5),delete J.event_params),r.cp&&r.cp.hasOwnProperty("uid")&&delete r.cp.uid,-1===r){const U=TargetAdsQueues.peek();return TargetAdsQueues.dequeue(U),this.log("TargetAds: Check add_to_cart data",!0)}r.event_name="add_to_cart"}else{if(!("purchase"===t&&Object.entries(e).length>0)||Array.isArray(e)){const R=TargetAdsQueues.peek();return TargetAdsQueues.dequeue(R),this.log("Can not send data",!0)}{const M={};for(let H in e)M[H]=e[H];if(r=this.prepaidEcomData(t,e),M.event_params&&"object"==typeof M.event_params&&!Array.isArray(M.event_params)&&(M.event_params.hasOwnProperty("uid")?(this.isValidString(this.convertToString(M.event_params.uid))?(r.uid=this.convertToString(M.event_params.uid),window.localStorage.setItem("_tads_uid",r.uid)):this.log("TargetAds: incorrect uid argument",!0),delete M.event_params.uid):this.log("TargetAds: uid argument not found",!0),r.cp=this.convertToObjectString(Object.assign(r.cp||{},M.event_params),5),delete M.event_params),r.cp&&r.cp.hasOwnProperty("uid")&&delete r.cp.uid,-1===r){const Y=TargetAdsQueues.peek();return TargetAdsQueues.dequeue(Y),this.log("TargetAds: Check purchase data",!0)}r.event_name="purchase"}}"object"==typeof r.cp&&r.cp.hasOwnProperty("uid")&&(this.isValidString(this.convertToString(r.cp.uid))||(this.log("TargetAds: incorrect uid argument in event_params",!0),delete r.cp.uid)),Object.assign(r,this.getOtherCounters());let s=Object.assign(this.defaultParams(),{edttm:Math.floor(Date.now()/1e3),sid:this.getSid()});if("page_view"===r.event_name){const F={ss:this.startSession};s=Object.assign(s,F)}let o=new URLSearchParams(s).toString();try{let z=JSON.stringify(r);this.req(o,z).catch((t=>this.log(t,!0)))}catch(G){return this.log(`Can not send data:${G}`,!0)}};class TargetAdsQueue{constructor(t={},e=0,r=0){this.elements=t,this.head=e,this.tail=r}enqueue(t){this.elements[this.tail]=t,this.tail++}dequeue(){const t=this.elements[this.head];return delete this.elements[this.head],this.head++,t}peek(){return this.elements[this.head]}get length(){return this.tail-this.head}get isEmpty(){return 0===this.length}}const TargetAdsQueues=new TargetAdsQueue,onHandlerEvent=(t=[])=>{try{if(t.length>0){if("init"===t[0])return t.length>1&&isNaN(t[1])?(console.log(`State:${JSON.stringify([...t].slice(1))}`),void console.warn("The ID of the TargetAds project is incorrect")):void localStorage.setItem("_tads_init",JSON.stringify([...t].slice(1).map((t=>t))));const e=JSON.parse(localStorage.getItem("_tads_init"));if(e&&e.length>0){const r=e[0];TargetAdsQueues.enqueue(t),localStorage.setItem(`_tads${r}_queue`,JSON.stringify(TargetAdsQueues))}else console.log(`State:${localStorage.getItem("_tads_init")}`),console.log("Error:First perform initialization TargetAds")}if(localStorage.getItem("_tads_init")){const t=JSON.parse(localStorage.getItem("_tads_init"));if(new TargetAds(t[0],t[1]).listenerLocation(),TargetAdsQueues.length>0){const e=TargetAdsQueues.peek();"object"==typeof e&&e.length>0?window._targetADS(e[0],e[1]):t&&t.length>1&&t[1]&&console.log("Error:TargetAds Queue item is empty")}else t&&t.length>1&&t[1]&&console.log("Error:TargetAds Queue is empty")}}catch(t){console.error("[TargetAds Error]: ",t)}};function TargetAdsIsStorageAvailable(){if("localStorage"in window||"object"==typeof localStorage){var t="TargetADSTest";try{return localStorage.setItem(t,t),"TargetADSTest"!==localStorage.getItem(t)?!1:(localStorage.removeItem(t),!0)}catch(t){return!1}}return!1}function TargetAdsIsCookiesAvailable(){if("undefined"==typeof navigator)return!1;if("boolean"==typeof navigator.cookieEnabled)return navigator.cookieEnabled;try{document.cookie="TargetAdsTest=1";const t=-1!==document.cookie.indexOf("TargetAdsTest=1");return document.cookie="TargetAdsTest=1; expires=Thu, 01 Jan 1970 00:00:00 GMT",t}catch(t){return!1}}"undefined"==typeof window||TargetAdsIsStorageAvailable()||console.log("TargetAds:LocalStorage unavailable"),"undefined"==typeof window||"undefined"==typeof navigator||TargetAdsIsCookiesAvailable()||console.log("TargetAds:Cookies unavailable");try{if(localStorage.getItem("_tads_init")){const t=JSON.parse(localStorage.getItem("_tads_init"));if(localStorage.getItem(`_tads${t[0]}_queue`)){const e=JSON.parse(localStorage.getItem(`_tads${t[0]}_queue`));localStorage.removeItem(`_tads${t[0]}_queue`);const r=new TargetAdsQueue(e.elements,e.head,e.tail);for(let e of Object.values(r.elements))new TargetAds(t[0],t[1]),window._targetADS(e[0],e[1])}}}catch(t){console.error("[TargetAds Error]: ",t)}const _targetadsGetId=()=>{try{const t=localStorage.getItem("_tads_init"),e=JSON.parse(t);if(e&&e[0]){const t=`_tads${e[0]}_cid`,r=window.localStorage.getItem(t);return r&&!isNaN(Number(r))?r:""}}catch(t){return""}};if(window.targetAdsDataLayer=new Proxy([],{set:function(t,e,r){try{return"data"===e&&(onHandlerEvent(r),!0)}catch(t){return console.error("[TargetAds Error]: ",t),!1}}}),"undefined"!=typeof window&&window.history&&"function"==typeof window.history.pushState&&window.history.state){let t=window.history.state,e=window.location.href;const r=setInterval((function(){if(localStorage.getItem("_tads_init")){const i=JSON.parse(localStorage.getItem("_tads_init"));if("object"!=typeof i[1]||!i[1].isCheckLocation)return void clearInterval(r);if(window.history.state!==t){t=window.history.state;const r=new TargetAds(i[0],i[1]);r.currentUrl=e;const s=r.onChangeLocation();s&&(e=s)}}}),2e3)}
//# sourceMappingURL=TargetAds_WebSDK.js.map